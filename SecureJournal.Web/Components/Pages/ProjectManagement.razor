@page "/admin/projects"
@attribute [Authorize(Roles = "Administrator")]
@inject ISecureJournalAppService JournalApp
@inject NavigationManager Navigation
@inject ILogger<ProjectManagement> Logger

<PageTitle>Project Management</PageTitle>

<section class="page-head">
    <div>
        <p class="eyebrow">Administration</p>
        <h2>Project Management</h2>
        <p>Manage project metadata and group access with server-side filtering, sorting, and paging.</p>
    </div>
</section>

@if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger" role="alert">@_error</div>
}

@if (!string.IsNullOrWhiteSpace(_message))
{
    <div class="alert alert-success" role="alert">@_message</div>
}

@if (_currentUser is null)
{
    <p>Loading current user...</p>
}
else if (_currentUser.Role != AppRole.Administrator)
{
    <div class="alert alert-warning" role="alert">
        Administrator access is required. Current user: <strong>@_currentUser.DisplayName</strong> (@_currentUser.Role).
    </div>
}
else
{
    <div class="project-admin-layout">
        <section class="panel-card project-admin-left">
            <div class="panel-card-header project-panel-header">
                <h3>Projects</h3>
                <div class="panel-card-header-actions project-panel-header-actions">
                    <span class="text-muted">@_projectPage.TotalCount total</span>
                    <label class="project-page-size-label" for="projectPageSize">Page size</label>
                    <select id="projectPageSize"
                            class="form-select form-select-sm project-page-size-select"
                            @onchange="OnProjectPageSizeChanged">
                        @foreach (var option in _pageSizeOptions)
                        {
                            <option value="@option" selected="@(option == _projectQuery.PageSize)">@option</option>
                        }
                    </select>
                </div>
            </div>

            <div class="row g-2 mb-3">
                <div class="col-md-8">
                    <label class="form-label" for="projectSearch">Search projects</label>
                    <input id="projectSearch"
                           class="form-control"
                           type="text"
                           value="@_projectQuery.FilterText"
                           @oninput="OnProjectSearchChanged"
                              placeholder="Filter by project code or name..." />
                </div>
            </div>

            @if (_projectPage.TotalCount == 0)
            {
                <p class="mb-0">No projects created yet.</p>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-sm project-table project-admin-projects-table mb-0">
                        <thead>
                            <tr>
                                <th><button type="button" class="btn btn-link p-0 table-sort" @onclick="@(() => ChangeProjectSortAsync("code"))">Code @SortGlyph("code", _projectQuery.SortField, _projectQuery.SortDirection)</button></th>
                                <th><button type="button" class="btn btn-link p-0 table-sort" @onclick="@(() => ChangeProjectSortAsync("name"))">Name @SortGlyph("name", _projectQuery.SortField, _projectQuery.SortDirection)</button></th>
                                <th>Assigned Groups</th>
                                <th><button type="button" class="btn btn-link p-0 table-sort" @onclick="@(() => ChangeProjectSortAsync("projectOwner"))">Owner @SortGlyph("projectOwner", _projectQuery.SortField, _projectQuery.SortDirection)</button></th>
                                <th><button type="button" class="btn btn-link p-0 table-sort" @onclick="@(() => ChangeProjectSortAsync("department"))">Department @SortGlyph("department", _projectQuery.SortField, _projectQuery.SortDirection)</button></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var project in _projectPage.Items)
                            {
                                <tr class="project-row @(project.ProjectId == _selectedProjectId ? "is-selected" : string.Empty)"
                                    @onclick="() => SelectProjectAsync(project.ProjectId)">
                                    <td class="project-code-cell"><code>@project.Code</code></td>
                                    <td class="project-name-cell">@project.Name</td>
                                    <td class="project-group-cell assigned-group-col">
                                        @if (project.AssignedGroups.Count == 0)
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                        else
                                        {
                                            <div class="project-group-tag-list">
                                                @foreach (var groupName in project.AssignedGroups)
                                                {
                                                    <span class="project-group-tag" title="@groupName">@groupName</span>
                                                }
                                            </div>
                                        }
                                    </td>
                                    <td class="project-detail-cell">@RenderValueOrDash(project.ProjectOwner)</td>
                                    <td class="project-detail-cell">@RenderValueOrDash(project.Department)</td>
                                    <td class="project-actions-cell">
                                        <button type="button"
                                                class="btn btn-outline-primary btn-sm project-edit-button"
                                                @onclick:stopPropagation="true"
                                                @onclick="() => StartEditProject(project.ProjectId)">
                                            Edit
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="pager-bar">
                    <span class="text-muted">Page @_projectPage.Page of @_projectPage.TotalPages</span>
                    <div class="d-flex gap-2">
                        <button type="button"
                                class="btn btn-outline-secondary btn-sm"
                                @onclick="GoToPreviousProjectPageAsync"
                                disabled="@(_projectPage.Page <= 1)">
                            Previous
                        </button>
                        <button type="button"
                                class="btn btn-outline-secondary btn-sm"
                                @onclick="GoToNextProjectPageAsync"
                                disabled="@(_projectPage.Page >= _projectPage.TotalPages)">
                            Next
                        </button>
                    </div>
                </div>
            }
        </section>

        <div class="project-admin-right">
            <section class="panel-card">
                <div class="panel-card-header">
                    <h3>Edit Project Metadata</h3>
                </div>

                @if (EditingProject is null)
                {
                    <p class="mb-0">Click <strong>Edit</strong> on a project row to update metadata.</p>
                }
                else
                {
                    <p class="text-muted mb-3">
                        Editing <strong>@EditingProject.Code - @EditingProject.Name</strong>.
                    </p>

                    <EditForm Model="_projectEditDraft" OnValidSubmit="SaveProjectMetadataAsync">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="project-metadata-grid">
                            <div class="project-metadata-main">
                                <label class="form-label" for="projectEditName">Name</label>
                                <InputText id="projectEditName" class="form-control" maxlength="100" @bind-Value="_projectEditDraft.Name" />
                            </div>

                            <div class="project-metadata-main">
                                <label class="form-label" for="projectEditDescription">Description</label>
                                <InputTextArea id="projectEditDescription" class="form-control" rows="3" maxlength="500" @bind-Value="_projectEditDraft.Description" />
                            </div>

                            <div>
                                <label class="form-label" for="projectEditOwner">Project Owner</label>
                                <InputText id="projectEditOwner" class="form-control" maxlength="100" @bind-Value="_projectEditDraft.ProjectOwner" />
                            </div>
                            <div>
                                <label class="form-label" for="projectEditDepartment">Department</label>
                                <InputText id="projectEditDepartment" class="form-control" maxlength="100" @bind-Value="_projectEditDraft.Department" />
                            </div>
                            <div>
                                <label class="form-label" for="projectEditEmail">Project owner email</label>
                                <InputText id="projectEditEmail" class="form-control" maxlength="254" @bind-Value="_projectEditDraft.ProjectEmail" />
                            </div>
                            <div>
                                <label class="form-label" for="projectEditPhone">Project owner phone</label>
                                <InputText id="projectEditPhone" class="form-control" maxlength="32" @bind-Value="_projectEditDraft.ProjectPhone" />
                            </div>
                        </div>

                        <div class="mt-3 d-flex gap-2">
                            <button type="submit" class="btn btn-primary" disabled="@_isSavingMetadata">@( _isSavingMetadata ? "Saving..." : "Save metadata")</button>
                            <button type="button" class="btn btn-outline-secondary" @onclick="CancelProjectEdit" disabled="@_isSavingMetadata">Cancel</button>
                        </div>
                    </EditForm>
                }
            </section>

            <section class="panel-card">
                <div class="panel-card-header">
                    <h3>Project Group Access</h3>
                    <span class="text-muted">@_groupAccessPage.TotalCount total groups</span>
                </div>

                @if (_projectPage.TotalCount == 0)
                {
                    <p class="mb-0">Create at least one project first.</p>
                }
                else if (SelectedProject is null)
                {
                    <p class="mb-0">Select a project to manage group access.</p>
                }
                else
                {
                    <p class="text-muted mb-3">
                        Editing <strong>@SelectedProject.Code - @SelectedProject.Name</strong>.
                        Check to grant access, uncheck to remove access.
                    </p>

                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <label class="form-label" for="groupSearch">Filter groups</label>
                            <input id="groupSearch"
                                   class="form-control"
                                   type="text"
                                   value="@_groupAccessQuery.FilterText"
                                   @oninput="OnGroupSearchChanged"
                                   placeholder="Search by group name..." />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" for="groupPageSize">Page size</label>
                            <select id="groupPageSize" class="form-select" @onchange="OnGroupPageSizeChanged">
                                @foreach (var option in _pageSizeOptions)
                                {
                                    <option value="@option" selected="@(option == _groupAccessQuery.PageSize)">@option</option>
                                }
                            </select>
                        </div>
                    </div>

                    @if (_groupAccessPage.TotalCount == 0)
                    {
                        <p class="mb-0">No groups available for the current filter.</p>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-sm align-middle mb-0 project-group-access-table">
                                <colgroup>
                                    <col class="project-group-access-col-group" />
                                    <col class="project-group-access-col-assigned" />
                                </colgroup>
                                <thead>
                                    <tr>
                                        <th><button type="button" class="btn btn-link p-0 table-sort" @onclick="@(() => ChangeGroupSortAsync("name"))">Group @SortGlyph("name", _groupAccessQuery.SortField, _groupAccessQuery.SortDirection)</button></th>
                                        <th class="text-end"><button type="button" class="btn btn-link p-0 table-sort" @onclick="@(() => ChangeGroupSortAsync("assigned"))">Assigned @SortGlyph("assigned", _groupAccessQuery.SortField, _groupAccessQuery.SortDirection)</button></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var group in _groupAccessPage.Items)
                                    {
                                        <tr>
                                            <td>@group.Name</td>
                                            <td class="text-end">
                                                <input class="form-check-input"
                                                       type="checkbox"
                                                       checked="@IsGroupAssigned(group)"
                                                       @onchange="args => ToggleGroupLocal(group, args)" />
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <div class="pager-bar">
                            <span class="text-muted">Page @_groupAccessPage.Page of @_groupAccessPage.TotalPages</span>
                            <div class="d-flex gap-2">
                                <button type="button"
                                        class="btn btn-outline-secondary btn-sm"
                                        @onclick="GoToPreviousGroupPageAsync"
                                        disabled="@(_groupAccessPage.Page <= 1)">
                                    Previous
                                </button>
                                <button type="button"
                                        class="btn btn-outline-secondary btn-sm"
                                        @onclick="GoToNextGroupPageAsync"
                                        disabled="@(_groupAccessPage.Page >= _groupAccessPage.TotalPages)">
                                    Next
                                </button>
                            </div>
                        </div>
                    }

                    <div class="mt-3 d-flex gap-2">
                        <button type="button" class="btn btn-primary" @onclick="SaveProjectGroupsAsync" disabled="@_isSaving">@( _isSaving ? "Saving..." : "Save")</button>
                        <button type="button" class="btn btn-outline-secondary" @onclick="ResetProjectGroupEdits" disabled="@(!_isDirty || _isSaving)">Reset</button>
                    </div>
                }
            </section>
        </div>
    </div>
}

@code {
    private readonly int[] _pageSizeOptions = [20, 30, 50, 100];
    private readonly UpdateProjectRequest _projectEditDraft = new();
    private UserContext? _currentUser;
    private PagedResult<ProjectOverview> _projectPage = new(Array.Empty<ProjectOverview>(), 0, 1, 20, 1);
    private PagedResult<GroupAccessRow> _groupAccessPage = new(Array.Empty<GroupAccessRow>(), 0, 1, 20, 1);
    private ProjectListQuery _projectQuery = new() { PageSize = 20, SortField = "code", IncludeDescriptionInFilter = false };
    private ProjectGroupAccessQuery _groupAccessQuery = new() { PageSize = 20, SortField = "name" };
    private Guid? _selectedProjectId;
    private Guid? _editingProjectId;
    private readonly Dictionary<Guid, bool> _pendingGroupAssignments = [];
    private bool _isSaving;
    private bool _isSavingMetadata;
    private string? _message;
    private string? _error;

    private bool _isDirty => _pendingGroupAssignments.Count > 0;

    private ProjectOverview? SelectedProject
        => _selectedProjectId is { } id
            ? _projectPage.Items.FirstOrDefault(p => p.ProjectId == id)
            : null;

    private ProjectOverview? EditingProject
        => _editingProjectId is { } id
            ? _projectPage.Items.FirstOrDefault(p => p.ProjectId == id)
            : null;

    protected override async Task OnInitializedAsync()
    {
        if (!await JournalApp.HasCurrentUserAsync())
        {
            Navigation.NavigateTo("/", forceLoad: false);
            return;
        }

        _currentUser = await JournalApp.GetCurrentUserAsync();
        await LoadProjectsAsync(selectFirstProjectIfNeeded: true);
    }

    private Task LoadProjectsAsync(bool selectFirstProjectIfNeeded = false)
    {
        _projectPage = JournalApp.GetProjects(_projectQuery);

        if (_projectPage.TotalCount == 0)
        {
            _selectedProjectId = null;
            _groupAccessPage = new PagedResult<GroupAccessRow>(Array.Empty<GroupAccessRow>(), 0, 1, _groupAccessQuery.PageSize, 1);
            _pendingGroupAssignments.Clear();
            return Task.CompletedTask;
        }

        if (selectFirstProjectIfNeeded || !_selectedProjectId.HasValue || !_projectPage.Items.Any(x => x.ProjectId == _selectedProjectId.Value))
        {
            _selectedProjectId = _projectPage.Items.FirstOrDefault()?.ProjectId;
            _pendingGroupAssignments.Clear();
        }

        if (_editingProjectId.HasValue && !_projectPage.Items.Any(x => x.ProjectId == _editingProjectId.Value))
        {
            CancelProjectEdit();
        }

        return LoadGroupAccessAsync();
    }

    private Task LoadGroupAccessAsync()
    {
        if (!_selectedProjectId.HasValue)
        {
            _groupAccessPage = new PagedResult<GroupAccessRow>(Array.Empty<GroupAccessRow>(), 0, 1, _groupAccessQuery.PageSize, 1);
            return Task.CompletedTask;
        }

        _groupAccessQuery.ProjectId = _selectedProjectId.Value;
        _groupAccessPage = JournalApp.GetProjectGroupAccess(_groupAccessQuery);
        return Task.CompletedTask;
    }

    private void StartEditProject(Guid projectId)
    {
        var project = _projectPage.Items.FirstOrDefault(x => x.ProjectId == projectId);
        if (project is null)
        {
            return;
        }

        _editingProjectId = project.ProjectId;
        _projectEditDraft.ProjectId = project.ProjectId;
        _projectEditDraft.Name = project.Name;
        _projectEditDraft.Description = project.Description;
        _projectEditDraft.ProjectOwner = project.ProjectOwner;
        _projectEditDraft.Department = project.Department;
        _projectEditDraft.ProjectEmail = project.ProjectEmail;
        _projectEditDraft.ProjectPhone = project.ProjectPhone;
        ClearMessages();
    }

    private async Task SaveProjectMetadataAsync()
    {
        if (_projectEditDraft.ProjectId == Guid.Empty)
        {
            _error = "Select a project to edit first.";
            return;
        }

        ClearMessages();
        _isSavingMetadata = true;

        try
        {
            var updated = JournalApp.UpdateProject(_projectEditDraft);
            _message = $"Project '{updated.Code}' metadata updated.";
            await LoadProjectsAsync();
            StartEditProject(updated.ProjectId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Admin project metadata update failed");
            _error = ex.Message;
        }
        finally
        {
            _isSavingMetadata = false;
        }
    }

    private async Task SaveProjectGroupsAsync()
    {
        var selectedProject = SelectedProject;
        if (selectedProject is null)
        {
            _error = "Select a project first.";
            return;
        }

        if (!_isDirty)
        {
            _message = "No group access changes to save.";
            _error = null;
            return;
        }

        ClearMessages();
        _isSaving = true;

        try
        {
            var adds = 0;
            var removes = 0;
            foreach (var (groupId, shouldBeAssigned) in _pendingGroupAssignments)
            {
                if (shouldBeAssigned)
                {
                    JournalApp.AssignGroupToProject(new AssignGroupToProjectRequest
                    {
                        ProjectId = selectedProject.ProjectId,
                        GroupId = groupId
                    });
                    adds++;
                }
                else
                {
                    JournalApp.RemoveGroupFromProject(new AssignGroupToProjectRequest
                    {
                        ProjectId = selectedProject.ProjectId,
                        GroupId = groupId
                    });
                    removes++;
                }
            }

            Logger.LogInformation("Saved project-group memberships for {ProjectCode}: adds={Adds}, removes={Removes}", selectedProject.Code, adds, removes);
            _pendingGroupAssignments.Clear();
            _message = $"Group access changes saved for project '{selectedProject.Code}'.";
            await LoadProjectsAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Project group membership save failed");
            _error = ex.Message;
        }
        finally
        {
            _isSaving = false;
        }
    }

    private Task SelectProjectAsync(Guid projectId)
    {
        if (_selectedProjectId == projectId)
        {
            return Task.CompletedTask;
        }

        _selectedProjectId = projectId;
        _pendingGroupAssignments.Clear();
        _groupAccessQuery.Page = 1;
        _message = null;
        _error = null;
        return LoadGroupAccessAsync();
    }

    private void ToggleGroupLocal(GroupAccessRow group, ChangeEventArgs args)
    {
        var isChecked = ParseCheckboxValue(args);
        if (isChecked == group.IsAssigned)
        {
            _pendingGroupAssignments.Remove(group.GroupId);
            return;
        }

        _pendingGroupAssignments[group.GroupId] = isChecked;
    }

    private bool IsGroupAssigned(GroupAccessRow row)
        => _pendingGroupAssignments.TryGetValue(row.GroupId, out var value) ? value : row.IsAssigned;

    private Task ResetProjectGroupEdits()
    {
        _pendingGroupAssignments.Clear();
        return LoadGroupAccessAsync();
    }

    private async Task OnProjectSearchChanged(ChangeEventArgs args)
    {
        _projectQuery.FilterText = args.Value?.ToString() ?? string.Empty;
        _projectQuery.Page = 1;
        await LoadProjectsAsync(selectFirstProjectIfNeeded: true);
    }

    private async Task OnProjectPageSizeChanged(ChangeEventArgs args)
    {
        if (int.TryParse(args.Value?.ToString(), out var pageSize) && _pageSizeOptions.Contains(pageSize))
        {
            _projectQuery.PageSize = pageSize;
            _projectQuery.Page = 1;
            await LoadProjectsAsync(selectFirstProjectIfNeeded: true);
        }
    }

    private async Task GoToPreviousProjectPageAsync()
    {
        if (_projectQuery.Page > 1)
        {
            _projectQuery.Page--;
            await LoadProjectsAsync(selectFirstProjectIfNeeded: true);
        }
    }

    private async Task GoToNextProjectPageAsync()
    {
        if (_projectQuery.Page < _projectPage.TotalPages)
        {
            _projectQuery.Page++;
            await LoadProjectsAsync(selectFirstProjectIfNeeded: true);
        }
    }

    private async Task ChangeProjectSortAsync(string field)
    {
        if (string.Equals(_projectQuery.SortField, field, StringComparison.OrdinalIgnoreCase))
        {
            _projectQuery.SortDirection = _projectQuery.SortDirection == SortDirection.Asc ? SortDirection.Desc : SortDirection.Asc;
        }
        else
        {
            _projectQuery.SortField = field;
            _projectQuery.SortDirection = SortDirection.Asc;
        }

        _projectQuery.Page = 1;
        await LoadProjectsAsync(selectFirstProjectIfNeeded: true);
    }

    private async Task OnGroupSearchChanged(ChangeEventArgs args)
    {
        _groupAccessQuery.FilterText = args.Value?.ToString() ?? string.Empty;
        _groupAccessQuery.Page = 1;
        await LoadGroupAccessAsync();
    }

    private async Task OnGroupPageSizeChanged(ChangeEventArgs args)
    {
        if (int.TryParse(args.Value?.ToString(), out var pageSize) && _pageSizeOptions.Contains(pageSize))
        {
            _groupAccessQuery.PageSize = pageSize;
            _groupAccessQuery.Page = 1;
            await LoadGroupAccessAsync();
        }
    }

    private async Task GoToPreviousGroupPageAsync()
    {
        if (_groupAccessQuery.Page > 1)
        {
            _groupAccessQuery.Page--;
            await LoadGroupAccessAsync();
        }
    }

    private async Task GoToNextGroupPageAsync()
    {
        if (_groupAccessQuery.Page < _groupAccessPage.TotalPages)
        {
            _groupAccessQuery.Page++;
            await LoadGroupAccessAsync();
        }
    }

    private async Task ChangeGroupSortAsync(string field)
    {
        if (string.Equals(_groupAccessQuery.SortField, field, StringComparison.OrdinalIgnoreCase))
        {
            _groupAccessQuery.SortDirection = _groupAccessQuery.SortDirection == SortDirection.Asc ? SortDirection.Desc : SortDirection.Asc;
        }
        else
        {
            _groupAccessQuery.SortField = field;
            _groupAccessQuery.SortDirection = SortDirection.Asc;
        }

        _groupAccessQuery.Page = 1;
        await LoadGroupAccessAsync();
    }

    private static string SortGlyph(string field, string currentField, SortDirection currentDirection)
        => string.Equals(currentField, field, StringComparison.OrdinalIgnoreCase)
            ? currentDirection == SortDirection.Asc ? "\u2191" : "\u2193"
            : string.Empty;

    private static string RenderValueOrDash(string? value)
        => string.IsNullOrWhiteSpace(value) ? "-" : value;

    private static bool ParseCheckboxValue(ChangeEventArgs args)
    {
        if (args.Value is bool boolValue)
        {
            return boolValue;
        }

        return bool.TryParse(args.Value?.ToString(), out var parsed) && parsed;
    }

    private void ClearMessages()
    {
        _message = null;
        _error = null;
    }

    private void CancelProjectEdit()
    {
        _editingProjectId = null;
        _projectEditDraft.ProjectId = Guid.Empty;
        _projectEditDraft.Name = string.Empty;
        _projectEditDraft.Description = string.Empty;
        _projectEditDraft.ProjectEmail = string.Empty;
        _projectEditDraft.ProjectPhone = string.Empty;
        _projectEditDraft.ProjectOwner = string.Empty;
        _projectEditDraft.Department = string.Empty;
    }
}
