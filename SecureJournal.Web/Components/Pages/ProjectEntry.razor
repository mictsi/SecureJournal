@page "/projects/entry/{RecordId:guid}"
@attribute [Authorize]
@inject ISecureJournalAppService JournalApp
@inject NavigationManager Navigation

<PageTitle>Journal Entry Details</PageTitle>

<section class="page-head">
    <div>
        <p class="eyebrow">Journal Entry</p>
        <h2>Entry details</h2>
        <p>Review full information for a single project journal entry.</p>
    </div>
    <a href="@BackUrl" class="btn btn-outline-secondary">Back to My Projects</a>
</section>

@if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger" role="alert">@_error</div>
}

@if (_entry is not null)
{
    <section class="panel-card">
        <div class="panel-card-header">
            <h3>@_entry.Subject</h3>
            <span class="text-muted">@_entry.ProjectCode - @_entry.ProjectName</span>
        </div>

        <dl class="meta-list">
            <dt>Created (UTC)</dt>
            <dd>@_entry.CreatedAtUtc.ToString("yyyy-MM-dd HH:mm") by @_entry.CreatedBy</dd>
            <dt>Action</dt>
            <dd>@_entry.Action</dd>
            <dt>Status</dt>
            <dd>@(_entry.IsSoftDeleted ? "Soft-deleted" : "Active")</dd>
            @if (_entry.IsSoftDeleted)
            {
                <dt>Deleted (UTC)</dt>
                <dd>@_entry.DeletedAtUtc?.ToString("yyyy-MM-dd HH:mm") by @_entry.DeletedBy</dd>
            }
        </dl>
    </section>

    <section class="panel-card mt-3">
        <div class="entry-view-grid">
            <div class="entry-view-block">
                <h4>Description</h4>
                <p class="entry-view-text">@_entry.Description</p>
            </div>
            <div class="entry-view-block">
                <h4>Notes</h4>
                <p class="entry-view-text">@(string.IsNullOrWhiteSpace(_entry.Notes) ? "No notes" : _entry.Notes)</p>
            </div>
            @if (_entry.IsSoftDeleted && !string.IsNullOrWhiteSpace(_entry.DeleteReason))
            {
                <div class="entry-view-block entry-view-block-full">
                    <h4>Delete reason</h4>
                    <p class="entry-view-text">@_entry.DeleteReason</p>
                </div>
            }
        </div>

        <div class="mt-3">
            <a href="@BackUrl" class="btn btn-outline-secondary">Back to My Projects</a>
        </div>
    </section>
}
else if (string.IsNullOrWhiteSpace(_error))
{
    <section class="panel-card">
        <p class="mb-0">Entry not found or you do not have access to view it.</p>
    </section>
}

@code {
    [Parameter]
    public Guid RecordId { get; set; }

    [SupplyParameterFromQuery(Name = "projectId")]
    public Guid? ProjectId { get; set; }

    private UserContext? _currentUser;
    private JournalEntryView? _entry;
    private string? _error;

    private string BackUrl
        => _entry is not null
            ? $"/projects?projectId={_entry.ProjectId:D}"
            : ProjectId.HasValue
                ? $"/projects?projectId={ProjectId.Value:D}"
                : "/projects";

    protected override async Task OnParametersSetAsync()
    {
        if (!await JournalApp.HasCurrentUserAsync())
        {
            Navigation.NavigateTo("/", forceLoad: false);
            return;
        }

        _currentUser = await JournalApp.GetCurrentUserAsync();
        if (_currentUser.Role == AppRole.Auditor)
        {
            _entry = null;
            _error = "Auditors cannot view full journal entry details.";
            return;
        }

        LoadEntry();
    }

    private void LoadEntry()
    {
        _error = null;
        _entry = null;

        try
        {
            var entries = JournalApp.GetJournalEntries(ProjectId, includeSoftDeleted: true);
            _entry = entries.FirstOrDefault(e => e.RecordId == RecordId);

            if (_entry is null && ProjectId.HasValue)
            {
                _entry = JournalApp.GetJournalEntries(projectId: null, includeSoftDeleted: true)
                    .FirstOrDefault(e => e.RecordId == RecordId);
            }

            if (_entry is null)
            {
                _error = "Journal entry was not found or is not accessible for your account.";
            }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }
}
