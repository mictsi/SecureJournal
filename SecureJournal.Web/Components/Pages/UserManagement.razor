@page "/admin/users"
@attribute [Authorize(Roles = "Administrator")]
@inject ISecureJournalAppService JournalApp
@inject NavigationManager Navigation
@inject ILogger<UserManagement> Logger
@inject IJSRuntime JS

<PageTitle>User management</PageTitle>

<section class="page-head">
    <div>
        <p class="eyebrow">Administration</p>
        <h2>User management</h2>
        <p>Manage user roles separately from user group memberships.</p>
    </div>
</section>

@if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger" role="alert">@_error</div>
}

@if (!string.IsNullOrWhiteSpace(_message))
{
    <div class="alert alert-success" role="alert">@_message</div>
}

@if (_currentUser is null)
{
    <p>Loading current user...</p>
}
else if (_currentUser.Role != AppRole.Administrator)
{
    <div class="alert alert-warning" role="alert">
        Administrator access is required. Current user: <strong>@_currentUser.DisplayName</strong> (@_currentUser.Role).
    </div>
}
else
{
    <div class="user-admin-layout">
        <section class="panel-card user-list-column">
            <div class="panel-card-header">
                <h3>Users</h3>
                <div class="panel-card-header-actions">
                    <span class="text-muted">@_userPage.TotalCount total</span>
                    <label class="project-page-size-label" for="userPageSize">Page size</label>
                    <select id="userPageSize"
                            class="form-select form-select-sm project-page-size-select"
                            @onchange="OnUserPageSizeChanged">
                        @foreach (var option in _pageSizeOptions)
                        {
                            <option value="@option" selected="@(option == _userQuery.PageSize)">@option</option>
                        }
                    </select>
                </div>
            </div>

            <div class="row g-2 mb-3">
                <div class="col-12">
                    <label class="form-label" for="userSearch">Search users</label>
                    <input id="userSearch"
                           class="form-control"
                           type="text"
                           value="@_userQuery.FilterText"
                           @oninput="OnUserSearchChanged"
                           placeholder="Filter username or display name..." />
                </div>
            </div>

            @if (_userPage.TotalCount == 0)
            {
                <p class="mb-0">No users found.</p>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                        <thead>
                            <tr>
                                <th><button type="button" class="btn btn-link p-0 table-sort" @onclick="@(() => ChangeUserSortAsync("username"))">Username @SortGlyph("username", _userQuery.SortField, _userQuery.SortDirection)</button></th>
                                <th><button type="button" class="btn btn-link p-0 table-sort" @onclick="@(() => ChangeUserSortAsync("displayName"))">Display Name @SortGlyph("displayName", _userQuery.SortField, _userQuery.SortDirection)</button></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in _userPage.Items)
                            {
                                <tr class="project-row @(user.UserId == _selectedUserId ? "is-selected" : string.Empty)"
                                    @onclick="() => SelectUserAsync(user.UserId)">
                                    <td><code>@user.Username</code></td>
                                    <td>@user.DisplayName</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="pager-bar">
                    <span class="text-muted">Page @_userPage.Page of @_userPage.TotalPages</span>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="GoToPreviousUserPageAsync" disabled="@(_userPage.Page <= 1)">Previous</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="GoToNextUserPageAsync" disabled="@(_userPage.Page >= _userPage.TotalPages)">Next</button>
                    </div>
                </div>
            }
        </section>

        <section class="panel-card user-groups-column">
            <div class="panel-card-header">
                <h3>Manage user groups</h3>
                <span class="text-muted">@_groupPage.TotalCount total groups</span>
            </div>

            @if (SelectedUser is null)
            {
                <p class="mb-0">Select a user to manage group memberships.</p>
            }
            else
            {
                <div class="row g-2 mb-3">
                    <div class="col-lg-5 col-md-12">
                        <label class="form-label" for="manageUserGroupSearch">Filter groups</label>
                        <input id="manageUserGroupSearch"
                               class="form-control"
                               type="text"
                               value="@_groupQuery.FilterText"
                               @oninput="OnGroupSearchChanged"
                               placeholder="Filter by group name..." />
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label" for="manageUserGroupAssigned">Assigned</label>
                        <select id="manageUserGroupAssigned" class="form-select" @onchange="OnGroupAssignedFilterChanged">
                            <option value="all" selected="@(!_groupQuery.Assigned.HasValue)">All</option>
                            <option value="assigned" selected="@(_groupQuery.Assigned == true)">Assigned</option>
                            <option value="unassigned" selected="@(_groupQuery.Assigned == false)">Unassigned</option>
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label" for="manageUserGroupPageSize">Page size</label>
                        <select id="manageUserGroupPageSize" class="form-select" @onchange="OnGroupPageSizeChanged">
                            @foreach (var option in _pageSizeOptions)
                            {
                                <option value="@option" selected="@(option == _groupQuery.PageSize)">@option</option>
                            }
                        </select>
                    </div>
                </div>

                @if (_groupPage.TotalCount == 0)
                {
                    <p class="mb-0">No groups available for the current filter.</p>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0">
                            <thead>
                                <tr>
                                    <th><button type="button" class="btn btn-link p-0 table-sort" @onclick="@(() => ChangeGroupSortAsync("name"))">Group @SortGlyph("name", _groupQuery.SortField, _groupQuery.SortDirection)</button></th>
                                    <th>Description</th>
                                    <th class="text-end"><button type="button" class="btn btn-link p-0 table-sort" @onclick="@(() => ChangeGroupSortAsync("assigned"))">Assigned @SortGlyph("assigned", _groupQuery.SortField, _groupQuery.SortDirection)</button></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var group in _groupPage.Items)
                                {
                                    <tr>
                                        <td>@group.Name</td>
                                        <td>@RenderValueOrDash(group.Description)</td>
                                        <td class="text-end">
                                            <input class="form-check-input"
                                                   type="checkbox"
                                                   checked="@IsGroupAssigned(group)"
                                                   @onchange="args => ToggleGroupLocal(group, args)" />
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="pager-bar">
                        <span class="text-muted">Page @_groupPage.Page of @_groupPage.TotalPages</span>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="GoToPreviousGroupPageAsync" disabled="@(_groupPage.Page <= 1)">Previous</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="GoToNextGroupPageAsync" disabled="@(_groupPage.Page >= _groupPage.TotalPages)">Next</button>
                        </div>
                    </div>
                }

                <div class="mt-3 d-flex gap-2">
                    <button type="button" class="btn btn-primary" @onclick="SaveGroupsAsync" disabled="@(!_groupsDirty || _isSaving)">Save groups</button>
                    <button type="button" class="btn btn-outline-secondary" @onclick="ResetGroupEdits" disabled="@(!_groupsDirty || _isSaving)">Reset groups</button>
                </div>
            }
        </section>

        <section class="panel-card user-detail-column">
            <div class="panel-card-header">
                <h3>Manage user</h3>
            </div>

            @if (SelectedUser is null)
            {
                <p class="mb-0">Select a user to manage profile and roles.</p>
            }
            else
            {
                <p class="text-muted mb-3">
                    Editing <strong>@SelectedUser.DisplayName</strong> (<code>@SelectedUser.Username</code>).
                </p>

                @if (SelectedUser.IsDisabled)
                {
                    <div class="alert alert-warning" role="alert">
                        This user is disabled and cannot sign in.
                    </div>
                }

                <section class="mb-3">
                    <h4 class="membership-title">Manage user roles</h4>
                    <div class="membership-list">
                        @foreach (var role in _roles)
                        {
                            <label class="form-check membership-item">
                                <input class="form-check-input"
                                       type="checkbox"
                                       checked="@_editedRoles.Contains(role)"
                                       @onchange="args => ToggleRoleLocal(role, args)" />
                                <span class="form-check-label">@role</span>
                            </label>
                        }
                    </div>
                </section>

                <div class="d-flex flex-wrap gap-2">
                    <button type="button" class="btn btn-primary" @onclick="SaveRolesAsync" disabled="@(!_rolesDirty || _isSaving)">Save roles</button>
                    <button type="button" class="btn btn-outline-secondary" @onclick="ResetRoleEdits" disabled="@(!_rolesDirty || _isSaving)">Reset roles</button>
                    <button type="button"
                            class="btn @(SelectedUser.IsDisabled ? "btn-success" : "btn-warning")"
                            @onclick="ToggleSelectedUserEnabledAsync"
                            disabled="@(_isSaving || IsSelectedCurrentUser)">
                        @(SelectedUser.IsDisabled ? "Enable user" : "Disable user")
                    </button>
                    <button type="button" class="btn btn-danger" @onclick="DeleteSelectedUserAsync" disabled="@(_isSaving || IsSelectedCurrentUser)">Delete user</button>
                </div>

                <hr />

                <section class="reset-password-panel">
                    <h4 class="membership-title">Reset local password</h4>
                    @if (!SelectedUser.IsLocalAccount)
                    {
                        <p class="text-muted mb-0">Password reset is available for local users only.</p>
                    }
                    else
                    {
                        <EditForm Model="_resetPasswordRequest" OnValidSubmit="ResetSelectedUserPasswordAsync">
                            <DataAnnotationsValidator />
                            <ValidationSummary />

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label" for="manageResetPassword">New Password</label>
                                    <InputText id="manageResetPassword"
                                               type="password"
                                               class="form-control"
                                               @bind-Value="_resetPasswordRequest.NewPassword" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="manageResetPasswordConfirm">Confirm New Password</label>
                                    <InputText id="manageResetPasswordConfirm"
                                               type="password"
                                               class="form-control"
                                               @bind-Value="_confirmResetPassword" />
                                </div>
                            </div>

                            <div class="form-text mt-2">Minimum length @_localPasswordMinLength. Local accounts only.</div>

                            <div class="mt-3 d-flex gap-2">
                                <button type="submit" class="btn btn-warning" disabled="@_isSaving">Reset Password</button>
                                <button type="button" class="btn btn-outline-secondary" @onclick="ResetLocalPasswordForm" disabled="@_isSaving">Clear</button>
                            </div>
                        </EditForm>
                    }
                </section>
            }
        </section>
    </div>
}

@code {
    private readonly AppRole[] _roles = [AppRole.Administrator, AppRole.ProjectUser, AppRole.Auditor];
    private readonly int[] _pageSizeOptions = [30, 50, 100];

    private UserContext? _currentUser;
    private PagedResult<UserOverview> _userPage = new(Array.Empty<UserOverview>(), 0, 1, 30, 1);
    private PagedResult<GroupAccessRow> _groupPage = new(Array.Empty<GroupAccessRow>(), 0, 1, 30, 1);
    private UserListQuery _userQuery = new() { PageSize = 30, SortField = "username" };
    private UserGroupMembershipQuery _groupQuery = new() { PageSize = 30, SortField = "name" };
    private Guid? _selectedUserId;

    private HashSet<AppRole> _originalRoles = [];
    private HashSet<AppRole> _editedRoles = [];
    private readonly Dictionary<Guid, bool> _pendingGroupAssignments = [];

    private AdminResetPasswordRequest _resetPasswordRequest = new();
    private string _confirmResetPassword = string.Empty;
    private int _localPasswordMinLength = 8;
    private bool _isSaving;
    private string? _message;
    private string? _error;

    private bool _rolesDirty => !_editedRoles.SetEquals(_originalRoles);
    private bool _groupsDirty => _pendingGroupAssignments.Count > 0;

    private UserOverview? SelectedUser
        => _selectedUserId is { } id
            ? _userPage.Items.FirstOrDefault(u => u.UserId == id)
            : null;

    private bool IsSelectedCurrentUser
        => SelectedUser?.UserId == _currentUser?.UserId;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (!await JournalApp.HasCurrentUserAsync())
            {
                Navigation.NavigateTo("/", forceLoad: false);
                return;
            }

            _currentUser = await JournalApp.GetCurrentUserAsync();
            _localPasswordMinLength = JournalApp.GetLocalPasswordMinLength();
            await LoadUsersAsync(selectFirstUserIfNeeded: true);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "User membership page initialization failed");
            _error = $"Failed to load user memberships: {ex.Message}";
        }
    }

    private Task LoadUsersAsync(bool selectFirstUserIfNeeded = false)
    {
        _userPage = JournalApp.GetUsers(_userQuery);
        if (_userPage.TotalCount == 0)
        {
            _selectedUserId = null;
            _groupPage = new PagedResult<GroupAccessRow>(Array.Empty<GroupAccessRow>(), 0, 1, _groupQuery.PageSize, 1);
            _originalRoles.Clear();
            _editedRoles.Clear();
            _pendingGroupAssignments.Clear();
            return Task.CompletedTask;
        }

        if (selectFirstUserIfNeeded || !_selectedUserId.HasValue || !_userPage.Items.Any(x => x.UserId == _selectedUserId.Value))
        {
            _selectedUserId = _userPage.Items.FirstOrDefault()?.UserId;
            InitializeSelectedUserEdits();
        }

        return LoadGroupsAsync();
    }

    private Task LoadGroupsAsync()
    {
        if (!_selectedUserId.HasValue)
        {
            _groupPage = new PagedResult<GroupAccessRow>(Array.Empty<GroupAccessRow>(), 0, 1, _groupQuery.PageSize, 1);
            return Task.CompletedTask;
        }

        _groupQuery.UserId = _selectedUserId.Value;
        _groupPage = JournalApp.GetUserGroups(_groupQuery);
        return Task.CompletedTask;
    }

    private Task SelectUserAsync(Guid userId)
    {
        if (_selectedUserId == userId)
        {
            return Task.CompletedTask;
        }

        _selectedUserId = userId;
        _message = null;
        _error = null;
        _groupQuery.Page = 1;
        InitializeSelectedUserEdits();
        return LoadGroupsAsync();
    }

    private void InitializeSelectedUserEdits()
    {
        var selected = SelectedUser;
        if (selected is null)
        {
            _originalRoles.Clear();
            _editedRoles.Clear();
            _pendingGroupAssignments.Clear();
            return;
        }

        _originalRoles = selected.Roles.Count > 0 ? selected.Roles.ToHashSet() : [selected.Role];
        _editedRoles = _originalRoles.ToHashSet();
        _pendingGroupAssignments.Clear();
        _resetPasswordRequest.UserId = selected.UserId;
        _resetPasswordRequest.NewPassword = string.Empty;
        _confirmResetPassword = string.Empty;
    }

    private async Task SaveRolesAsync()
    {
        var selectedUser = SelectedUser;
        if (selectedUser is null)
        {
            _error = "Select a user first.";
            return;
        }

        if (!_rolesDirty)
        {
            _message = "No role changes to save.";
            _error = null;
            return;
        }

        try
        {
            _isSaving = true;
            _message = null;
            _error = null;

            var roleAdds = _editedRoles.Except(_originalRoles).ToList();
            var roleRemoves = _originalRoles.Except(_editedRoles).ToList();

            foreach (var role in roleAdds)
            {
                JournalApp.AddUserToRole(new UserRoleMembershipRequest { UserId = selectedUser.UserId, Role = role });
            }

            foreach (var role in roleRemoves)
            {
                JournalApp.RemoveUserFromRole(new UserRoleMembershipRequest { UserId = selectedUser.UserId, Role = role });
            }

            await LoadUsersAsync();
            InitializeSelectedUserEdits();
            _message = $"Roles updated for user '{selectedUser.Username}'.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Saving user roles failed");
            _error = ex.Message;
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task SaveGroupsAsync()
    {
        var selectedUser = SelectedUser;
        if (selectedUser is null)
        {
            _error = "Select a user first.";
            return;
        }

        if (!_groupsDirty)
        {
            _message = "No group membership changes to save.";
            _error = null;
            return;
        }

        try
        {
            _isSaving = true;
            _message = null;
            _error = null;

            foreach (var (groupId, shouldBeAssigned) in _pendingGroupAssignments)
            {
                if (shouldBeAssigned)
                {
                    JournalApp.AssignUserToGroup(new AssignUserToGroupRequest { UserId = selectedUser.UserId, GroupId = groupId });
                }
                else
                {
                    JournalApp.RemoveUserFromGroup(new AssignUserToGroupRequest { UserId = selectedUser.UserId, GroupId = groupId });
                }
            }

            _pendingGroupAssignments.Clear();
            await LoadUsersAsync();
            await LoadGroupsAsync();
            _message = $"Group memberships updated for user '{selectedUser.Username}'.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Saving user groups failed");
            _error = ex.Message;
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void ToggleRoleLocal(AppRole role, ChangeEventArgs args)
    {
        var isChecked = ParseCheckboxValue(args);
        if (isChecked)
        {
            _editedRoles.Add(role);
            return;
        }

        _editedRoles.Remove(role);
    }

    private void ToggleGroupLocal(GroupAccessRow group, ChangeEventArgs args)
    {
        var isChecked = ParseCheckboxValue(args);
        if (isChecked == group.IsAssigned)
        {
            _pendingGroupAssignments.Remove(group.GroupId);
            return;
        }

        _pendingGroupAssignments[group.GroupId] = isChecked;
    }

    private bool IsGroupAssigned(GroupAccessRow row)
        => _pendingGroupAssignments.TryGetValue(row.GroupId, out var value) ? value : row.IsAssigned;

    private void ResetRoleEdits()
    {
        _editedRoles = _originalRoles.ToHashSet();
    }

    private Task ResetGroupEdits()
    {
        _pendingGroupAssignments.Clear();
        return LoadGroupsAsync();
    }

    private async Task ToggleSelectedUserEnabledAsync()
    {
        var selectedUser = SelectedUser;
        if (selectedUser is null)
        {
            _error = "Select a user first.";
            return;
        }

        var shouldEnable = selectedUser.IsDisabled;
        var actionVerb = shouldEnable ? "enable" : "disable";

        var confirmed = await JS.InvokeAsync<bool>(
            "confirm",
            shouldEnable
                ? $"Enable user '{selectedUser.Username}'?"
                : $"Disable user '{selectedUser.Username}'? This blocks all app access.");
        if (!confirmed)
        {
            return;
        }

        try
        {
            _isSaving = true;
            _message = null;
            _error = null;

            var changed = shouldEnable
                ? await JournalApp.EnableUserAsync(selectedUser.UserId)
                : await JournalApp.DisableUserAsync(selectedUser.UserId);
            await LoadUsersAsync();
            _message = changed
                ? $"User '{selectedUser.Username}' was {actionVerb}d."
                : $"User '{selectedUser.Username}' is already {actionVerb}d.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Toggle user enabled state failed");
            _error = ex.Message;
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task DeleteSelectedUserAsync()
    {
        var selectedUser = SelectedUser;
        if (selectedUser is null)
        {
            _error = "Select a user first.";
            return;
        }

        var confirmed = await JS.InvokeAsync<bool>(
            "confirm",
            $"Delete user '{selectedUser.Username}'? This cannot be undone.");
        if (!confirmed)
        {
            return;
        }

        try
        {
            _isSaving = true;
            _message = null;
            _error = null;

            await JournalApp.DeleteUserAsync(selectedUser.UserId);
            await LoadUsersAsync(selectFirstUserIfNeeded: true);
            _message = $"User '{selectedUser.Username}' was deleted.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Delete user failed");
            _error = ex.Message;
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task ResetSelectedUserPasswordAsync()
    {
        var selectedUser = SelectedUser;
        if (selectedUser is null)
        {
            _error = "Select a user first.";
            return;
        }

        if (!selectedUser.IsLocalAccount)
        {
            _error = "Password reset is supported for local users only.";
            return;
        }

        if (_resetPasswordRequest.NewPassword != _confirmResetPassword)
        {
            _error = "New password and confirm password must match.";
            return;
        }

        try
        {
            _isSaving = true;
            _message = null;
            _error = null;

            _resetPasswordRequest.UserId = selectedUser.UserId;
            var result = await JournalApp.ResetLocalUserPasswordAsync(_resetPasswordRequest);
            if (!result.Success)
            {
                _error = result.Message;
                return;
            }

            _message = result.Message;
            ResetLocalPasswordForm();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Reset selected user password failed");
            _error = ex.Message;
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task OnUserSearchChanged(ChangeEventArgs args)
    {
        _userQuery.FilterText = args.Value?.ToString() ?? string.Empty;
        _userQuery.Page = 1;
        await LoadUsersAsync(selectFirstUserIfNeeded: true);
    }

    private async Task OnUserPageSizeChanged(ChangeEventArgs args)
    {
        if (int.TryParse(args.Value?.ToString(), out var pageSize) && _pageSizeOptions.Contains(pageSize))
        {
            _userQuery.PageSize = pageSize;
            _userQuery.Page = 1;
            await LoadUsersAsync(selectFirstUserIfNeeded: true);
        }
    }

    private async Task GoToPreviousUserPageAsync()
    {
        if (_userQuery.Page > 1)
        {
            _userQuery.Page--;
            await LoadUsersAsync(selectFirstUserIfNeeded: true);
        }
    }

    private async Task GoToNextUserPageAsync()
    {
        if (_userQuery.Page < _userPage.TotalPages)
        {
            _userQuery.Page++;
            await LoadUsersAsync(selectFirstUserIfNeeded: true);
        }
    }

    private async Task ChangeUserSortAsync(string field)
    {
        if (string.Equals(_userQuery.SortField, field, StringComparison.OrdinalIgnoreCase))
        {
            _userQuery.SortDirection = _userQuery.SortDirection == SortDirection.Asc ? SortDirection.Desc : SortDirection.Asc;
        }
        else
        {
            _userQuery.SortField = field;
            _userQuery.SortDirection = SortDirection.Asc;
        }

        _userQuery.Page = 1;
        await LoadUsersAsync(selectFirstUserIfNeeded: true);
    }

    private async Task OnGroupSearchChanged(ChangeEventArgs args)
    {
        _groupQuery.FilterText = args.Value?.ToString() ?? string.Empty;
        _groupQuery.Page = 1;
        await LoadGroupsAsync();
    }

    private async Task OnGroupAssignedFilterChanged(ChangeEventArgs args)
    {
        var raw = args.Value?.ToString()?.Trim().ToLowerInvariant();
        _groupQuery.Assigned = raw switch
        {
            "assigned" => true,
            "unassigned" => false,
            _ => null
        };
        _groupQuery.Page = 1;
        await LoadGroupsAsync();
    }

    private async Task OnGroupPageSizeChanged(ChangeEventArgs args)
    {
        if (int.TryParse(args.Value?.ToString(), out var pageSize) && _pageSizeOptions.Contains(pageSize))
        {
            _groupQuery.PageSize = pageSize;
            _groupQuery.Page = 1;
            await LoadGroupsAsync();
        }
    }

    private async Task GoToPreviousGroupPageAsync()
    {
        if (_groupQuery.Page > 1)
        {
            _groupQuery.Page--;
            await LoadGroupsAsync();
        }
    }

    private async Task GoToNextGroupPageAsync()
    {
        if (_groupQuery.Page < _groupPage.TotalPages)
        {
            _groupQuery.Page++;
            await LoadGroupsAsync();
        }
    }

    private async Task ChangeGroupSortAsync(string field)
    {
        if (string.Equals(_groupQuery.SortField, field, StringComparison.OrdinalIgnoreCase))
        {
            _groupQuery.SortDirection = _groupQuery.SortDirection == SortDirection.Asc ? SortDirection.Desc : SortDirection.Asc;
        }
        else
        {
            _groupQuery.SortField = field;
            _groupQuery.SortDirection = SortDirection.Asc;
        }

        _groupQuery.Page = 1;
        await LoadGroupsAsync();
    }

    private void ResetLocalPasswordForm()
    {
        _resetPasswordRequest.NewPassword = string.Empty;
        _confirmResetPassword = string.Empty;
    }

    private static bool ParseCheckboxValue(ChangeEventArgs args)
    {
        if (args.Value is bool boolValue)
        {
            return boolValue;
        }

        return bool.TryParse(args.Value?.ToString(), out var parsed) && parsed;
    }

    private static string SortGlyph(string field, string currentField, SortDirection currentDirection)
        => string.Equals(currentField, field, StringComparison.OrdinalIgnoreCase)
            ? currentDirection == SortDirection.Asc ? "\u2191" : "\u2193"
            : string.Empty;

    private static string RenderValueOrDash(string? value)
        => string.IsNullOrWhiteSpace(value) ? "-" : value;
}
