@page "/login"
@inject ISecureJournalAppService JournalApp
@inject PrototypeSessionCookieCoordinator SessionCookies
@inject NavigationManager Navigation
@inject ILogger<Login> Logger
@inject IConfiguration Configuration

<PageTitle>My Settings</PageTitle>

<section class="page-head">
    <div>
        <p class="eyebrow">My Settings</p>
        <h2>My Settings</h2>
        <p>
            Uses users stored in the configured app database. The startup administrator is configured in `appsettings` under `BootstrapAdmin`.
            Root (`/`) is the public login page. This page is available after sign-in for account actions.
        </p>
    </div>
</section>

@if (!string.IsNullOrWhiteSpace(_message))
{
    <div class="alert alert-success" role="alert">@_message</div>
}

@if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger" role="alert">@_error</div>
}

<div class="settings-layout">
    <div class="settings-column settings-column-left">
        <section class="panel-card">
            <h3>My information</h3>
            <dl class="meta-list mb-0">
                <dt>Display Name</dt>
                <dd>@_currentUser?.DisplayName</dd>
                <dt>Username</dt>
                <dd><code>@_currentUser?.Username</code></dd>
                <dt>Role</dt>
                <dd>@_currentUser?.Role</dd>
            </dl>
        </section>

        <section class="panel-card">
            <h3>Change Password</h3>
            <p class="text-muted">
                Changes the password for the current local account. Non-local accounts cannot use this form.
                Minimum password length: @_passwordMinLength. Password complexity requires uppercase, lowercase, digit, and special character (configurable in appsettings).
            </p>
            <EditForm Model="PasswordChangeModel" OnValidSubmit="ChangePasswordAsync" FormName="change-password-form">
                <AntiforgeryToken />
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label" for="currentPassword">Current Password</label>
                        <InputText id="currentPassword" class="form-control" type="password" @bind-Value="PasswordChangeModel.CurrentPassword" />
                    </div>
                    <div class="col-12">
                        <label class="form-label" for="newPassword">New Password</label>
                        <InputText id="newPassword" class="form-control" type="password" @bind-Value="PasswordChangeModel.NewPassword" />
                    </div>
                    <div class="col-12">
                        <label class="form-label" for="confirmPassword">Confirm New Password</label>
                        <InputText id="confirmPassword" class="form-control" type="password" @bind-Value="PasswordChangeModel.ConfirmPassword" />
                    </div>
                </div>

                <div class="mt-3 d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Change Password</button>
                    <button type="button" class="btn btn-outline-secondary" @onclick="ResetPasswordChange">Reset</button>
                </div>
            </EditForm>
        </section>

        <section class="panel-card">
            <h3>Login</h3>
            @if (_enableLocalLogin)
            {
                @if (_enableAspNetIdentity)
                {
                    <form method="post" action="/auth/local-login" data-enhance="false">
                        <AntiforgeryToken />
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label" for="loginUsername">Username</label>
                                <input id="loginUsername" class="form-control" name="username" autocomplete="username" required />
                            </div>
                            <div class="col-12">
                                <label class="form-label" for="loginPassword">Password</label>
                                <input id="loginPassword" class="form-control" type="password" name="password" autocomplete="current-password" required />
                            </div>
                        </div>
                        <input type="hidden" name="returnUrl" value="/projects" />
                        <input type="hidden" name="failurePath" value="/login" />

                        <div class="mt-3 d-flex gap-2">
                            <button type="submit" class="btn btn-primary">Login</button>
                        </div>
                    </form>
                }
                else
                {
                    <EditForm Model="LoginModel" OnValidSubmit="LoginAsync" FormName="login-form">
                        <AntiforgeryToken />
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label" for="loginUsername">Username</label>
                                <InputText id="loginUsername" class="form-control" @bind-Value="LoginModel.Username" />
                            </div>
                            <div class="col-12">
                                <label class="form-label" for="loginPassword">Password</label>
                                <InputText id="loginPassword" class="form-control" type="password" @bind-Value="LoginModel.Password" />
                            </div>
                        </div>

                        <div class="mt-3 d-flex gap-2">
                            <button type="submit" class="btn btn-primary">Login</button>
                            <button type="button" class="btn btn-outline-secondary" @onclick="ResetLogin">Reset</button>
                        </div>
                    </EditForm>
                }
            }

            @if (_enableOidc)
            {
                <div class="mt-3">
                    <a class="btn btn-oidc"
                       href="/auth/oidc-login?returnUrl=%2Fprojects"
                       data-enhance-nav="false">
                        Login with OpenID
                    </a>
                </div>
            }
        </section>
    </div>

    <div class="settings-column settings-column-right"></div>
</div>

@code {
    [SupplyParameterFromQuery(Name = "error")]
    private string? QueryError { get; set; }

    [SupplyParameterFromQuery(Name = "message")]
    private string? QueryMessage { get; set; }

    [SupplyParameterFromForm(FormName = "login-form")]
    private LoginForm? PostedLoginModel { get; set; }
    private LoginForm LoginModel => PostedLoginModel ??= new();

    [SupplyParameterFromForm(FormName = "change-password-form")]
    private ChangePasswordForm? PostedPasswordChangeModel { get; set; }
    private ChangePasswordForm PasswordChangeModel => PostedPasswordChangeModel ??= new();
    private string? _message;
    private string? _error;
    private int _passwordMinLength;
    private bool _enableLocalLogin;
    private bool _enableOidc;
    private bool _enableAspNetIdentity;
    private UserContext? _currentUser;

    protected override async Task OnInitializedAsync()
    {
        if (!await JournalApp.HasCurrentUserAsync())
        {
            Navigation.NavigateTo("/", forceLoad: false);
            return;
        }

        _enableLocalLogin = bool.TryParse(Configuration["Authentication:EnableLocalLogin"], out var localLogin) && localLogin;
        _enableOidc = bool.TryParse(Configuration["Authentication:EnableOidc"], out var oidc) && oidc;
        _enableAspNetIdentity = bool.TryParse(Configuration["Authentication:EnableAspNetIdentity"], out var identity) && identity;
        _passwordMinLength = JournalApp.GetLocalPasswordMinLength();
        _currentUser = await JournalApp.GetCurrentUserAsync();
    }

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrWhiteSpace(QueryError))
        {
            _error = QueryError;
        }

        if (!string.IsNullOrWhiteSpace(QueryMessage))
        {
            _message = QueryMessage;
        }
    }

    private async Task LoginAsync()
    {
        ClearMessages();
        Logger.LogInformation("Login form submitted for username {Username}", LoginModel.Username);

        try
        {
            var result = await JournalApp.TryLocalLoginAsync(LoginModel.Username, LoginModel.Password);
            if (!result.Success)
            {
                Logger.LogWarning("Login failed for username {Username}: {Message}", LoginModel.Username, result.Message);
                _error = result.Message;
                return;
            }

            Logger.LogInformation("Login succeeded for username {Username}", LoginModel.Username);
            await SessionCookies.PersistCurrentLoginAsync();
            _message = result.Message;
            ResetLogin();
            Navigation.NavigateTo("/projects", forceLoad: false);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Login form submit threw an exception for username {Username}", LoginModel.Username);
            _error = ex.Message;
        }
    }

    private async Task ChangePasswordAsync()
    {
        ClearMessages();
        Logger.LogInformation("Change password form submitted for current user");

        if (!string.Equals(PasswordChangeModel.NewPassword, PasswordChangeModel.ConfirmPassword, StringComparison.Ordinal))
        {
            Logger.LogWarning("Change password validation failed: new password confirmation mismatch");
            _error = "New password and confirmation do not match.";
            return;
        }

        try
        {
            var result = await JournalApp.ChangeCurrentUserPasswordAsync(new ChangePasswordRequest
            {
                CurrentPassword = PasswordChangeModel.CurrentPassword,
                NewPassword = PasswordChangeModel.NewPassword
            });

            if (!result.Success)
            {
                Logger.LogWarning("Password change failed: {Message}", result.Message);
                _error = result.Message;
                return;
            }

            Logger.LogInformation("Password change succeeded");
            _message = result.Message;
            ResetPasswordChange();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Change password form submit threw an exception");
            _error = ex.Message;
        }
    }

    private void ClearMessages()
    {
        _message = null;
        _error = null;
    }

    private void ResetLogin()
    {
        LoginModel.Username = string.Empty;
        LoginModel.Password = string.Empty;
    }

    private void ResetPasswordChange()
    {
        PasswordChangeModel.CurrentPassword = string.Empty;
        PasswordChangeModel.NewPassword = string.Empty;
        PasswordChangeModel.ConfirmPassword = string.Empty;
    }

    private sealed class LoginForm
    {
        [Required]
        public string Username { get; set; } = string.Empty;

        [Required]
        public string Password { get; set; } = string.Empty;
    }

    private sealed class ChangePasswordForm
    {
        [Required]
        public string CurrentPassword { get; set; } = string.Empty;

        [Required]
        public string NewPassword { get; set; } = string.Empty;

        [Required]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
