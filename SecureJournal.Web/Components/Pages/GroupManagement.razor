@page "/admin/groups"
@attribute [Authorize(Roles = "Administrator")]
@inject ISecureJournalAppService JournalApp
@inject NavigationManager Navigation
@inject ILogger<GroupManagement> Logger

<PageTitle>Group Management</PageTitle>

<section class="page-head">
    <div>
        <p class="eyebrow">Administration</p>
        <h2>Group Management</h2>
        <p>Create groups and review group membership/project mappings.</p>
    </div>
</section>

@if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger" role="alert">@_error</div>
}

@if (!string.IsNullOrWhiteSpace(_message))
{
    <div class="alert alert-success" role="alert">@_message</div>
}

@if (_currentUser is null)
{
    <p>Loading current user...</p>
}
else if (_currentUser.Role != AppRole.Administrator)
{
    <div class="alert alert-warning" role="alert">
        Administrator access is required. Current user: <strong>@_currentUser.DisplayName</strong> (@_currentUser.Role).
    </div>
}
else
{
    <div class="group-admin-layout">
        <section class="panel-card group-create-card">
            <div class="panel-card-header">
                <h3>Create Group</h3>
            </div>
            <EditForm Model="GroupDraft" OnValidSubmit="CreateGroupAsync" FormName="admin-group-create">
                <AntiforgeryToken />
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label" for="groupName">Group Name</label>
                        <InputText id="groupName" class="form-control" maxlength="100" @bind-Value="GroupDraft.Name" />
                    </div>
                </div>

                <div class="mt-3 d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Create Group</button>
                    <button type="button" class="btn btn-outline-secondary" @onclick="ResetGroupForm">Reset</button>
                </div>
            </EditForm>
        </section>

        <section class="panel-card group-list-card">
            <div class="panel-card-header">
                <h3>Groups</h3>
                <span class="text-muted">@_groups.Count</span>
            </div>
            @if (_groups.Count == 0)
            {
                <p class="mb-0">No groups created yet.</p>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-sm group-table mb-0">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Members</th>
                                <th>Projects</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var group in _groups)
                            {
                                <tr>
                                    <td>@group.Name</td>
                                    <td>@FormatList(group.Members)</td>
                                    <td>@FormatList(group.ProjectCodes)</td>
                                    <td>
                                        <button type="button"
                                                class="btn btn-outline-danger btn-sm"
                                                @onclick="() => DeleteGroupAsync(group.GroupId, group.Name)"
                                                disabled="@(_isDeleting && _deletingGroupId == group.GroupId)">
                                            @(_isDeleting && _deletingGroupId == group.GroupId ? "Deleting..." : "Delete")
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </section>
    </div>
}

@code {
    [SupplyParameterFromForm(FormName = "admin-group-create")]
    private CreateGroupRequest? PostedGroupDraft { get; set; }
    private CreateGroupRequest GroupDraft => PostedGroupDraft ??= new();

    private UserContext? _currentUser;
    private List<GroupOverview> _groups = new();
    private bool _isDeleting;
    private Guid? _deletingGroupId;
    private string? _message;
    private string? _error;

    protected override async Task OnInitializedAsync()
    {
        if (!await JournalApp.HasCurrentUserAsync())
        {
            Navigation.NavigateTo("/", forceLoad: false);
            return;
        }

        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _currentUser = await JournalApp.GetCurrentUserAsync();
        _groups = JournalApp.GetGroups().ToList();
    }

    private async Task CreateGroupAsync()
    {
        ClearMessages();
        Logger.LogInformation("Admin group form submit: CreateGroup {GroupName}", GroupDraft.Name);

        try
        {
            var group = JournalApp.CreateGroup(GroupDraft);
            _message = $"Group '{group.Name}' created.";
            ResetGroupForm();
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Admin group create failed");
            _error = ex.Message;
        }

    }

    private async Task DeleteGroupAsync(Guid groupId, string groupName)
    {
        if (groupId == Guid.Empty)
        {
            return;
        }

        ClearMessages();
        _isDeleting = true;
        _deletingGroupId = groupId;
        Logger.LogInformation("Admin group action: DeleteGroup {GroupId} ({GroupName})", groupId, groupName);

        try
        {
            var deleted = JournalApp.DeleteGroup(groupId);
            _message = deleted
                ? $"Group '{groupName}' deleted."
                : $"Group '{groupName}' was already removed.";

            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Admin group delete failed for GroupId={GroupId}", groupId);
            _error = ex.Message;
        }
        finally
        {
            _isDeleting = false;
            _deletingGroupId = null;
        }
    }

    private void ResetGroupForm()
    {
        GroupDraft.Name = string.Empty;
    }

    private void ClearMessages()
    {
        _message = null;
        _error = null;
    }

    private static string FormatList(IReadOnlyList<string> values)
        => values.Count == 0 ? "-" : string.Join(", ", values);
}
