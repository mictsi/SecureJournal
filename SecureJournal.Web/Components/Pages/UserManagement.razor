@page "/admin/users"
@attribute [Authorize(Roles = "Administrator")]
@inject ISecureJournalAppService JournalApp
@inject NavigationManager Navigation
@inject ILogger<UserManagement> Logger
@inject IJSRuntime JS

<PageTitle>User management</PageTitle>

<section class="page-head">
    <div>
        <p class="eyebrow">Administration</p>
        <h2>User management</h2>
        <p>Select a user, choose memberships, and manage account state/password.</p>
    </div>
</section>

@if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger" role="alert">@_error</div>
}

@if (!string.IsNullOrWhiteSpace(_message))
{
    <div class="alert alert-success" role="alert">@_message</div>
}

@if (_currentUser is null)
{
    <p>Loading current user...</p>
}
else if (_currentUser.Role != AppRole.Administrator)
{
    <div class="alert alert-warning" role="alert">
        Administrator access is required. Current user: <strong>@_currentUser.DisplayName</strong> (@_currentUser.Role).
    </div>
}
else
{
    <div class="user-admin-layout">
        <section class="panel-card user-list-column">
            <div class="panel-card-header">
                <h3>Users</h3>
                <span class="text-muted">@_users.Count</span>
            </div>

            @if (_users.Count == 0)
            {
                <p class="mb-0">No users created yet.</p>
            }
            else
            {
                <div class="user-list">
                    @foreach (var user in _users)
                    {
                        <button type="button"
                                class="user-list-item @(user.UserId == _selectedUserId ? "is-selected" : string.Empty)"
                                @onclick="() => SelectUser(user.UserId)">
                            <div class="user-list-item-top">
                                <strong>@user.DisplayName</strong>
                            </div>
                            <div class="user-list-item-meta">
                                <code>@user.Username</code>
                                <span>@(user.IsLocalAccount ? "Local" : "External")</span>
                            </div>
                            <div class="user-list-item-meta">
                                <span>Roles: @FormatRoles(user.Roles)</span>
                                @if (user.IsDisabled)
                                {
                                    <span class="user-disabled-badge">Disabled</span>
                                }
                            </div>
                        </button>
                    }
                </div>
            }
        </section>

        <div class="user-detail-column">
            <section class="panel-card">
                <div class="panel-card-header">
                    <h3>Manage user</h3>
                </div>

                @if (SelectedUser is null)
                {
                    <p class="mb-0">Select a user to manage memberships.</p>
                }
                else
                {
                    <p class="text-muted mb-3">
                        Editing <strong>@SelectedUser.DisplayName</strong> (<code>@SelectedUser.Username</code>).
                        Check to add membership, uncheck to remove.
                    </p>
                    @if (SelectedUser.IsDisabled)
                    {
                        <div class="alert alert-warning" role="alert">
                            This user is disabled and cannot sign in.
                        </div>
                    }

                    <div class="membership-grid">
                        <div>
                            <h4 class="membership-title">Groups</h4>
                            @if (_groups.Count == 0)
                            {
                                <p class="mb-0">No groups available.</p>
                            }
                            else
                            {
                                <div class="membership-list">
                                    @foreach (var group in _groups)
                                    {
                                        <label class="form-check membership-item">
                                            <input class="form-check-input"
                                                   type="checkbox"
                                                   checked="@_editedGroupIds.Contains(group.GroupId)"
                                                   @onchange="args => ToggleGroupLocal(group.GroupId, args)" />
                                            <span class="form-check-label">@group.Name</span>
                                        </label>
                                    }
                                </div>
                            }
                        </div>

                        <div>
                            <h4 class="membership-title">Roles</h4>
                            <div class="membership-list">
                                @foreach (var role in _roles)
                                {
                                    <label class="form-check membership-item">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               checked="@_editedRoles.Contains(role)"
                                               @onchange="args => ToggleRoleLocal(role, args)" />
                                        <span class="form-check-label">@role</span>
                                    </label>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="mt-3 d-flex gap-2">
                        <button type="button" class="btn btn-primary" @onclick="SaveMembershipsAsync" disabled="@_isSaving">@( _isSaving ? "Saving..." : "Save")</button>
                        <button type="button" class="btn btn-outline-secondary" @onclick="ResetEdits" disabled="@(!_isDirty || _isSaving)">Reset</button>
                        <button type="button"
                                class="btn @(SelectedUser.IsDisabled ? "btn-success" : "btn-warning")"
                                @onclick="ToggleSelectedUserEnabledAsync"
                                disabled="@(_isSaving || IsSelectedCurrentUser)">
                            @(SelectedUser.IsDisabled ? "Enable user" : "Disable user")
                        </button>
                        <button type="button" class="btn btn-danger" @onclick="DeleteSelectedUserAsync" disabled="@(_isSaving || IsSelectedCurrentUser)">Delete user</button>
                    </div>

                    <hr />

                    <section class="reset-password-panel">
                        <h4 class="membership-title">Reset local password</h4>
                        @if (!SelectedUser.IsLocalAccount)
                        {
                            <p class="text-muted mb-0">Password reset is available for local users only.</p>
                        }
                        else
                        {
                            <EditForm Model="_resetPasswordRequest" OnValidSubmit="ResetSelectedUserPasswordAsync">
                                <DataAnnotationsValidator />
                                <ValidationSummary />

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label" for="manageResetPassword">New Password</label>
                                        <InputText id="manageResetPassword"
                                                   type="password"
                                                   class="form-control"
                                                   @bind-Value="_resetPasswordRequest.NewPassword" />
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="manageResetPasswordConfirm">Confirm New Password</label>
                                        <InputText id="manageResetPasswordConfirm"
                                                   type="password"
                                                   class="form-control"
                                                   @bind-Value="_confirmResetPassword" />
                                    </div>
                                </div>

                                <div class="form-text mt-2">Minimum length @_localPasswordMinLength. Local accounts only.</div>

                                <div class="mt-3 d-flex gap-2">
                                    <button type="submit" class="btn btn-warning" disabled="@_isSaving">Reset Password</button>
                                    <button type="button" class="btn btn-outline-secondary" @onclick="ResetLocalPasswordForm" disabled="@_isSaving">Clear</button>
                                </div>
                            </EditForm>
                        }
                    </section>
                }
            </section>
        </div>
    </div>
}

@code {
    private readonly AppRole[] _roles = [AppRole.Administrator, AppRole.ProjectUser, AppRole.Auditor];

    private UserContext? _currentUser;
    private List<UserOverview> _users = new();
    private List<GroupOverview> _groups = new();
    private Guid? _selectedUserId;

    private HashSet<Guid> _originalGroupIds = [];
    private HashSet<AppRole> _originalRoles = [];
    private HashSet<Guid> _editedGroupIds = [];
    private HashSet<AppRole> _editedRoles = [];
    private AdminResetPasswordRequest _resetPasswordRequest = new();
    private string _confirmResetPassword = string.Empty;
    private int _localPasswordMinLength = 8;
    private bool _isDirty;
    private bool _isSaving;

    private string? _message;
    private string? _error;

    private UserOverview? SelectedUser
        => _selectedUserId is { } id
            ? _users.FirstOrDefault(u => u.UserId == id)
            : null;

    private bool IsSelectedCurrentUser
        => SelectedUser?.UserId == _currentUser?.UserId;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (!await JournalApp.HasCurrentUserAsync())
            {
                Navigation.NavigateTo("/", forceLoad: false);
                return;
            }

            _localPasswordMinLength = JournalApp.GetLocalPasswordMinLength();
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "User membership page initialization failed");
            _error = $"Failed to load user memberships: {ex.Message}";
        }
    }

    private async Task LoadDataAsync()
    {
        _currentUser = await JournalApp.GetCurrentUserAsync();
        _users = JournalApp.GetUsers().ToList();
        _groups = JournalApp.GetGroups().ToList();

        if (_users.Count == 0)
        {
            _selectedUserId = null;
            _originalGroupIds.Clear();
            _originalRoles.Clear();
            _editedGroupIds.Clear();
            _editedRoles.Clear();
            _isDirty = false;
            return;
        }

        var selectedId = _selectedUserId is { } existingId && _users.Any(u => u.UserId == existingId)
            ? existingId
            : _users[0].UserId;

        SelectUser(selectedId);
    }

    private void SelectUser(Guid userId)
    {
        _selectedUserId = userId;
        _message = null;
        _error = null;

        var selected = SelectedUser;
        if (selected is null)
        {
            _originalGroupIds.Clear();
            _originalRoles.Clear();
            _editedGroupIds.Clear();
            _editedRoles.Clear();
            _isDirty = false;
            return;
        }

        var groupNames = selected.Groups.ToHashSet(StringComparer.OrdinalIgnoreCase);
        _originalGroupIds = _groups
            .Where(g => groupNames.Contains(g.Name))
            .Select(g => g.GroupId)
            .ToHashSet();

        _originalRoles = selected.Roles.Count > 0
            ? selected.Roles.ToHashSet()
            : [selected.Role];

        _editedGroupIds = _originalGroupIds.ToHashSet();
        _editedRoles = _originalRoles.ToHashSet();
        _resetPasswordRequest.UserId = selected.UserId;
        _resetPasswordRequest.NewPassword = string.Empty;
        _confirmResetPassword = string.Empty;
        _isDirty = false;
    }

    private void ToggleGroupLocal(Guid groupId, ChangeEventArgs args)
    {
        var isChecked = ParseCheckboxValue(args);
        if (isChecked)
        {
            _editedGroupIds.Add(groupId);
        }
        else
        {
            _editedGroupIds.Remove(groupId);
        }

        UpdateDirtyState();
    }

    private void ToggleRoleLocal(AppRole role, ChangeEventArgs args)
    {
        var isChecked = ParseCheckboxValue(args);
        if (isChecked)
        {
            _editedRoles.Add(role);
        }
        else
        {
            _editedRoles.Remove(role);
        }

        UpdateDirtyState();
    }

    private async Task SaveMembershipsAsync()
    {
        var selectedUser = SelectedUser;
        if (selectedUser is null)
        {
            _error = "Select a user first.";
            return;
        }

        if (!_isDirty)
        {
            _message = "No membership changes to save.";
            _error = null;
            return;
        }

        try
        {
            _isSaving = true;
            Logger.LogWarning("Starting membership save for {Username}", selectedUser.Username);
            _message = null;
            _error = null;
            await Task.Yield();

            var groupAdds = _editedGroupIds.Except(_originalGroupIds).ToList();
            var groupRemoves = _originalGroupIds.Except(_editedGroupIds).ToList();
            var roleAdds = _editedRoles.Except(_originalRoles).ToList();
            var roleRemoves = _originalRoles.Except(_editedRoles).ToList();
            var selectedUserId = selectedUser.UserId;

            Logger.LogWarning(
                "Saving user memberships for {Username}: GroupAdds={GroupAdds} GroupRemoves={GroupRemoves} RoleAdds={RoleAdds} RoleRemoves={RoleRemoves}",
                selectedUser.Username,
                groupAdds.Count,
                groupRemoves.Count,
                roleAdds.Count,
                roleRemoves.Count);

            foreach (var groupId in groupAdds)
            {
                Logger.LogWarning("Applying membership change: add user {UserId} to group {GroupId}", selectedUserId, groupId);
                JournalApp.AssignUserToGroup(new AssignUserToGroupRequest
                {
                    UserId = selectedUserId,
                    GroupId = groupId
                });
                await Task.Yield();
            }

            foreach (var groupId in groupRemoves)
            {
                Logger.LogWarning("Applying membership change: remove user {UserId} from group {GroupId}", selectedUserId, groupId);
                JournalApp.RemoveUserFromGroup(new AssignUserToGroupRequest
                {
                    UserId = selectedUserId,
                    GroupId = groupId
                });
                await Task.Yield();
            }

            foreach (var role in roleAdds)
            {
                Logger.LogWarning("Applying membership change: add role {Role} to user {UserId}", role, selectedUserId);
                JournalApp.AddUserToRole(new UserRoleMembershipRequest
                {
                    UserId = selectedUserId,
                    Role = role
                });
                await Task.Yield();
            }

            foreach (var role in roleRemoves)
            {
                Logger.LogWarning("Applying membership change: remove role {Role} from user {UserId}", role, selectedUserId);
                JournalApp.RemoveUserFromRole(new UserRoleMembershipRequest
                {
                    UserId = selectedUserId,
                    Role = role
                });
                await Task.Yield();
            }

            Logger.LogWarning("Refreshing user/group data after membership save for {Username}", selectedUser.Username);
            _users = JournalApp.GetUsers().ToList();
            _groups = JournalApp.GetGroups().ToList();
            SelectUser(selectedUserId);

            Logger.LogWarning("Completed membership save for {Username}", selectedUser.Username);
            _message = $"Membership changes saved for {selectedUser.Username}.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Saving user memberships failed");
            _error = ex.Message;
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task ToggleSelectedUserEnabledAsync()
    {
        var selectedUser = SelectedUser;
        if (selectedUser is null)
        {
            _error = "Select a user first.";
            return;
        }

        var shouldEnable = selectedUser.IsDisabled;
        var actionVerb = shouldEnable ? "enable" : "disable";

        var confirmed = await JS.InvokeAsync<bool>(
            "confirm",
            shouldEnable
                ? $"Enable user '{selectedUser.Username}'?"
                : $"Disable user '{selectedUser.Username}'? This blocks all app access.");
        if (!confirmed)
        {
            return;
        }

        try
        {
            _isSaving = true;
            _message = null;
            _error = null;

            var changed = shouldEnable
                ? await JournalApp.EnableUserAsync(selectedUser.UserId)
                : await JournalApp.DisableUserAsync(selectedUser.UserId);
            await LoadDataAsync();
            _message = changed
                ? $"User '{selectedUser.Username}' was {actionVerb}d."
                : $"User '{selectedUser.Username}' is already {actionVerb}d.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Toggle user enabled state failed");
            _error = ex.Message;
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task DeleteSelectedUserAsync()
    {
        var selectedUser = SelectedUser;
        if (selectedUser is null)
        {
            _error = "Select a user first.";
            return;
        }

        var confirmed = await JS.InvokeAsync<bool>(
            "confirm",
            $"Delete user '{selectedUser.Username}'? This cannot be undone.");
        if (!confirmed)
        {
            return;
        }

        try
        {
            _isSaving = true;
            _message = null;
            _error = null;

            await JournalApp.DeleteUserAsync(selectedUser.UserId);
            await LoadDataAsync();
            _message = $"User '{selectedUser.Username}' was deleted.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Delete user failed");
            _error = ex.Message;
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task ResetSelectedUserPasswordAsync()
    {
        var selectedUser = SelectedUser;
        if (selectedUser is null)
        {
            _error = "Select a user first.";
            return;
        }

        if (!selectedUser.IsLocalAccount)
        {
            _error = "Password reset is supported for local users only.";
            return;
        }

        if (_resetPasswordRequest.NewPassword != _confirmResetPassword)
        {
            _error = "New password and confirm password must match.";
            return;
        }

        try
        {
            _isSaving = true;
            _message = null;
            _error = null;

            _resetPasswordRequest.UserId = selectedUser.UserId;
            var result = await JournalApp.ResetLocalUserPasswordAsync(_resetPasswordRequest);
            if (!result.Success)
            {
                _error = result.Message;
                return;
            }

            _message = result.Message;
            ResetLocalPasswordForm();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Reset selected user password failed");
            _error = ex.Message;
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void ResetEdits()
    {
        _editedGroupIds = _originalGroupIds.ToHashSet();
        _editedRoles = _originalRoles.ToHashSet();
        _isDirty = false;
    }

    private void ResetLocalPasswordForm()
    {
        _resetPasswordRequest.NewPassword = string.Empty;
        _confirmResetPassword = string.Empty;
    }

    private void UpdateDirtyState()
    {
        _isDirty = !_editedGroupIds.SetEquals(_originalGroupIds)
            || !_editedRoles.SetEquals(_originalRoles);
    }

    private static bool ParseCheckboxValue(ChangeEventArgs args)
    {
        if (args.Value is bool boolValue)
        {
            return boolValue;
        }

        return bool.TryParse(args.Value?.ToString(), out var parsed) && parsed;
    }

    private static string FormatRoles(IReadOnlyList<AppRole> roles)
        => roles.Count == 0 ? "-" : string.Join(", ", roles);
}
