@page "/admin/groups"
@attribute [Authorize(Roles = "Administrator")]
@inject ISecureJournalAppService JournalApp
@inject NavigationManager Navigation
@inject ILogger<GroupManagement> Logger

<PageTitle>Group Management</PageTitle>

<section class="page-head">
    <div>
        <p class="eyebrow">Administration</p>
        <h2>Group Management</h2>
        <p>Manage group metadata and memberships with server-side filtering, sorting, and paging.</p>
    </div>
</section>

@if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger" role="alert">@_error</div>
}

@if (!string.IsNullOrWhiteSpace(_message))
{
    <div class="alert alert-success" role="alert">@_message</div>
}

@if (_currentUser is null)
{
    <p>Loading current user...</p>
}
else if (_currentUser.Role != AppRole.Administrator)
{
    <div class="alert alert-warning" role="alert">
        Administrator access is required. Current user: <strong>@_currentUser.DisplayName</strong> (@_currentUser.Role).
    </div>
}
else
{
    <section class="panel-card group-list-card">
        <div class="panel-card-header">
            <h3>Groups</h3>
            <div class="panel-card-header-actions">
                <span class="text-muted">@_groupPage.TotalCount total</span>
                <label class="project-page-size-label" for="groupPageSize">Page size</label>
                <select id="groupPageSize"
                        class="form-select form-select-sm project-page-size-select"
                        @onchange="OnPageSizeChanged">
                    @foreach (var option in _pageSizeOptions)
                    {
                        <option value="@option" selected="@(option == _groupQuery.PageSize)">@option</option>
                    }
                </select>
            </div>
        </div>

        <div class="row g-2 mb-3">
            <div class="col-md-8">
                <label class="form-label" for="groupSearch">Search groups</label>
                <input id="groupSearch"
                       class="form-control"
                       type="text"
                       value="@_groupQuery.FilterText"
                       @oninput="OnSearchChanged"
                       placeholder="Filter by name or description..." />
            </div>
        </div>

        @if (_groupPage.TotalCount == 0)
        {
            <p class="mb-0">No groups found.</p>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-sm group-table mb-0">
                    <thead>
                        <tr>
                            <th><button type="button" class="btn btn-link p-0 table-sort" @onclick="@(() => ChangeSortAsync("name"))">Name @SortGlyph("name", _groupQuery.SortField, _groupQuery.SortDirection)</button></th>
                            <th><button type="button" class="btn btn-link p-0 table-sort" @onclick="@(() => ChangeSortAsync("description"))">Description @SortGlyph("description", _groupQuery.SortField, _groupQuery.SortDirection)</button></th>
                            <th>Members</th>
                            <th>Projects</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var group in _groupPage.Items)
                        {
                            <tr>
                                <td>@group.Name</td>
                                <td>@RenderValueOrDash(group.Description)</td>
                                <td>@FormatList(group.Members)</td>
                                <td>@FormatList(group.ProjectCodes)</td>
                                <td>
                                    <button type="button"
                                            class="btn btn-outline-danger btn-sm"
                                            @onclick="() => DeleteGroupAsync(group.GroupId, group.Name)"
                                            disabled="@(_isDeleting && _deletingGroupId == group.GroupId)">
                                        @(_isDeleting && _deletingGroupId == group.GroupId ? "Deleting..." : "Delete")
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="pager-bar">
                <span class="text-muted">Page @_groupPage.Page of @_groupPage.TotalPages</span>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="GoToPreviousPageAsync" disabled="@(_groupQuery.Page <= 1)">Previous</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="GoToNextPageAsync" disabled="@(_groupQuery.Page >= _groupPage.TotalPages)">Next</button>
                </div>
            </div>
        }
    </section>
}

@code {
    private readonly int[] _pageSizeOptions = [30, 50, 100];
    private UserContext? _currentUser;
    private GroupListQuery _groupQuery = new() { PageSize = 30, SortField = "name" };
    private PagedResult<GroupOverview> _groupPage = new(Array.Empty<GroupOverview>(), 0, 1, 30, 1);
    private bool _isDeleting;
    private Guid? _deletingGroupId;
    private string? _message;
    private string? _error;

    protected override async Task OnInitializedAsync()
    {
        if (!await JournalApp.HasCurrentUserAsync())
        {
            Navigation.NavigateTo("/", forceLoad: false);
            return;
        }

        _currentUser = await JournalApp.GetCurrentUserAsync();
        await LoadDataAsync();
    }

    private Task LoadDataAsync()
    {
        _groupPage = JournalApp.GetGroups(_groupQuery);
        return Task.CompletedTask;
    }

    private async Task DeleteGroupAsync(Guid groupId, string groupName)
    {
        if (groupId == Guid.Empty)
        {
            return;
        }

        ClearMessages();
        _isDeleting = true;
        _deletingGroupId = groupId;

        try
        {
            var deleted = JournalApp.DeleteGroup(groupId);
            _message = deleted
                ? $"Group '{groupName}' deleted."
                : $"Group '{groupName}' was already removed.";

            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Admin group delete failed for GroupId={GroupId}", groupId);
            _error = ex.Message;
        }
        finally
        {
            _isDeleting = false;
            _deletingGroupId = null;
        }
    }

    private async Task OnSearchChanged(ChangeEventArgs args)
    {
        _groupQuery.FilterText = args.Value?.ToString() ?? string.Empty;
        _groupQuery.Page = 1;
        await LoadDataAsync();
    }

    private async Task OnPageSizeChanged(ChangeEventArgs args)
    {
        if (int.TryParse(args.Value?.ToString(), out var pageSize) && _pageSizeOptions.Contains(pageSize))
        {
            _groupQuery.PageSize = pageSize;
            _groupQuery.Page = 1;
            await LoadDataAsync();
        }
    }

    private async Task ChangeSortAsync(string field)
    {
        if (string.Equals(_groupQuery.SortField, field, StringComparison.OrdinalIgnoreCase))
        {
            _groupQuery.SortDirection = _groupQuery.SortDirection == SortDirection.Asc ? SortDirection.Desc : SortDirection.Asc;
        }
        else
        {
            _groupQuery.SortField = field;
            _groupQuery.SortDirection = SortDirection.Asc;
        }

        _groupQuery.Page = 1;
        await LoadDataAsync();
    }

    private async Task GoToPreviousPageAsync()
    {
        if (_groupQuery.Page > 1)
        {
            _groupQuery.Page--;
            await LoadDataAsync();
        }
    }

    private async Task GoToNextPageAsync()
    {
        if (_groupQuery.Page < _groupPage.TotalPages)
        {
            _groupQuery.Page++;
            await LoadDataAsync();
        }
    }

    private void ClearMessages()
    {
        _message = null;
        _error = null;
    }

    private static string SortGlyph(string field, string currentField, SortDirection currentDirection)
        => string.Equals(currentField, field, StringComparison.OrdinalIgnoreCase)
            ? currentDirection == SortDirection.Asc ? "\u2191" : "\u2193"
            : string.Empty;

    private static string FormatList(IReadOnlyList<string> values)
        => values.Count == 0 ? "-" : string.Join(", ", values);

    private static string RenderValueOrDash(string? value)
        => string.IsNullOrWhiteSpace(value) ? "-" : value;
}
